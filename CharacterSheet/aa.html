<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Grid with JSON Import/Export</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
        }
        .grid {
            display: grid;
            background-color: #ccc;
            padding: 1px;
            position: relative;
        }
        .cell {
            width: 50px;
            height: 50px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .shape {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 2;
            border: none;
        }
        .circle {
            border: 2px solid blue;
            border-radius: 50%;
            
        }
        .square {
            border: 2px solid red;
        }
        .shape input {
            width: 70px;
            text-align: center;
            border: none;
            background: transparent;
        }
        .shape input {
            border: none;

        }
        input[type="text"] {
        outline: none;  
        user-select: none;
        -webkit-user-select: none; /* Para Safari y Chrome */
        }
        .controls {
            margin-top: 20px;
        }
        button, input[type="file"] {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .line {
            position: absolute;
            background-color: #000;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="grid" class="grid"></div>
        <div class="controls">
            <button id="downloadJSON">Download JSON</button>
        </div>
    </div>

    <script>
        let GRID_SIZE = 20;
        let currentShape = 'circle';
        let linkMode = false;
        let unlinkMode = false;
        let grid = [];
        let links = [];

        function initializeGrid() {
            grid = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill({ shape: null, text: '' }));
        }

        function createGrid() {
            const gridElement = document.getElementById('grid');
            gridElement.innerHTML = ''; // Clear existing grid
            gridElement.style.gridTemplateColumns = `repeat(${GRID_SIZE}, 50px)`;
            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                   // cell.addEventListener('click', handleCellClick);
                    gridElement.appendChild(cell);
                    if (grid[i][j].shape) {
                        addShapeToCell(cell, grid[i][j].shape, grid[i][j].text);
                    }
                }
            }
            redrawAllLines();
        }

        function addShapeToCell(cell, shape, text) {
            const shapeElement = document.createElement('div');
            shapeElement.className = `shape ${shape}`;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = text;
            input.readOnly = true;
            input.addEventListener('click', (e) => e.stopPropagation());
           /* input.addEventListener('input', (e) => {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                grid[row][col].text = e.target.value;
            });*/
            shapeElement.appendChild(input);
            cell.appendChild(shapeElement);
        }

     

        function toggleShape(cell, row, col) {
            if (grid[row][col].shape === currentShape) {
                grid[row][col] = { shape: null, text: '' };
                cell.innerHTML = '';
            } else {
                grid[row][col] = { shape: currentShape, text: '' };
                addShapeToCell(cell, currentShape, '');
            }
        }

        let selectedNodes = [];

        function handleLinkUnlink(row, col) {
            if (grid[row][col].shape) {
                selectedNodes.push({row, col});
                highlightCell(row, col);

                if (selectedNodes.length === 2) {
                    if (linkMode) {
                        linkNodes();
                    } else if (unlinkMode) {
                        unlinkNodes();
                    }
                    selectedNodes = [];
                    resetHighlights();
                    linkMode = false;
                    unlinkMode = false;
                    updateButtonStates();
                }
            }
        }

        function linkNodes() {
            const [node1, node2] = selectedNodes;
            if (!isAlreadyLinked(node1, node2)) {
                links.push({ from: node1, to: node2 });
                drawLine(node1, node2);
            }
        }

        function unlinkNodes() {
            const [node1, node2] = selectedNodes;
            links = links.filter(link => 
                !((link.from.row === node1.row && link.from.col === node1.col &&
                   link.to.row === node2.row && link.to.col === node2.col) ||
                  (link.from.row === node2.row && link.from.col === node2.col &&
                   link.to.row === node1.row && link.to.col === node1.col))
            );
            redrawAllLines();
        }

        function isAlreadyLinked(node1, node2) {
            return links.some(link => 
                (link.from.row === node1.row && link.from.col === node1.col &&
                 link.to.row === node2.row && link.to.col === node2.col) ||
                (link.from.row === node2.row && link.from.col === node2.col &&
                 link.to.row === node1.row && link.to.col === node1.col)
            );
        }

        function highlightCell(row, col) {
            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            if (cell) cell.style.outline = '2px solid green';
        }

        function resetHighlights() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => cell.style.outline = '');
        }

        function drawLine(from, to) {
            const gridElement = document.getElementById('grid');
            const line = document.createElement('div');
            line.className = 'line';
            const fromRect = gridElement.children[from.row * GRID_SIZE + from.col].getBoundingClientRect();
            const toRect = gridElement.children[to.row * GRID_SIZE + to.col].getBoundingClientRect();
            const gridRect = gridElement.getBoundingClientRect();

            const length = Math.sqrt(Math.pow(to.col - from.col, 2) + Math.pow(to.row - from.row, 2)) * 50;
            const angle = Math.atan2(to.row - from.row, to.col - from.col) * 180 / Math.PI;

            line.style.width = `${length}px`;
            line.style.height = '2px';
            line.style.left = `${fromRect.left - gridRect.left + 25}px`;
            line.style.top = `${fromRect.top - gridRect.top + 25}px`;
            line.style.transform = `rotate(${angle}deg)`;
            line.style.transformOrigin = '0 0';

            gridElement.appendChild(line);
        }

        function redrawAllLines() {
            const gridElement = document.getElementById('grid');
            const existingLines = gridElement.querySelectorAll('.line');
            existingLines.forEach(line => line.remove());
            links.forEach(link => drawLine(link.from, link.to));
        }

        

        function loadJSONFile() {
            fetch('./data.json')
    .then((response) => response.json())
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    try {
                        const data = JSON.parse(content);
                        buildGridFromJSON(data);
                    } catch (error) {
                        console.error('Error parsing JSON:', error);
                        alert('Invalid JSON file');
                    }
                };
                reader.readAsText(file);
            }
        }

        function buildGridFromJSON(data) {
            GRID_SIZE = data.gridSize || 5;
            initializeGrid();
            data.nodes.forEach(node => {
                const [row, col] = node.position;
                grid[row][col] = { shape: node.shape, text: node.text };
            });
            links = data.links || [];
            createGrid();
        }

        function updateButtonStates() {
            document.getElementById('linkNodes').disabled = linkMode;
            document.getElementById('unlinkNodes').disabled = unlinkMode;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeGrid();
            createGrid();
            fetch('Atributos.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load the JSON file: ' + response.statusText);
                    }
                    return response.json(); // Parse the JSON
                })
                .then(data => {
                     buildGridFromJSON(data);
                })
          
            document.getElementById('downloadJSON').addEventListener('click', downloadJSON);
            document.getElementById('uploadJSON').addEventListener('change', loadJSONFile);
        });
    </script>
</body>
</html>
