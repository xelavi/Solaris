<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circular RPG Skill Tree Creator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        #skill-tree {
            width: 600px;
            height: 600px;
            border: 2px solid #333;
            border-radius: 50%;
            position: relative;
            background-color: white;
            margin: 0 auto;
        }
        .node {
            width: 60px;
            height: 60px;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            z-index: 2;
        }
        .node-circle {
            border-radius: 50%;
            border: 2px solid #333;
            background-color: #f9f9f9;
        }
        .node-square {
            border: 2px solid #333;
            background-color: #f9f9f9;
        }
        .node-highlight {
            border-color: #1890ff;
            background-color: #e6f7ff;
        }
        .arrow {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }
        #controls {
            margin-top: 20px;
            text-align: center;
        }
        button {
            margin-right: 10px;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Circular RPG Skill Tree Creator</h1>
    <div id="skill-tree"></div>
    <div id="controls">
        <button id="add-circle">Add Circle Node</button>
        <button id="add-square">Add Square Node</button>
        <button id="link-nodes">Link Nodes</button>
        <button id="unlink-nodes">Unlink Nodes</button>
        <button id="downloadJSON" onclick="downloadJSON()">Download JSON</button>
    </div>

    <script>
        const skillTree = document.getElementById('skill-tree');
        const addCircleBtn = document.getElementById('add-circle');
        const addSquareBtn = document.getElementById('add-square');
        const linkNodesBtn = document.getElementById('link-nodes');
        const unlinkNodesBtn = document.getElementById('unlink-nodes');
        const downloadJSON = document.getElementById('downloadJSON');

        let nodes = [];
        let links = [];
        let selectedNodes = [];
        let linkMode = false;
        let unlinkMode = false;

        function createNode(shape) {
            const node = document.createElement('div');
            node.className = `node node-${shape}`;
            const angle = Math.random() * 2 * Math.PI;
            const radius = Math.random() * 200 + 100; // Adjust based on skill tree size
            const x = 300 + radius * Math.cos(angle) - 30;
            const y = 300 + radius * Math.sin(angle) - 30;
            node.style.left = `${x}px`;
            node.style.top = `${y}px`;
            node.textContent = shape === 'circle' ? '+1' : 'Skill';
            
            node.addEventListener('dblclick', () => {
                const newName = prompt('Enter new name for the node:', node.textContent);
                if (newName) node.textContent = newName;
            });

            node.addEventListener('mousedown', startDragging);
            node.addEventListener('click', selectNode);
            
            skillTree.appendChild(node);
            nodes.push(node);
        }

        function startDragging(e) {
            const node = e.target;
            let startX = e.clientX - node.offsetLeft;
            let startY = e.clientY - node.offsetTop;

            function moveNode(e) {
                const x = e.clientX - startX;
                const y = e.clientY - startY;
                const centerX = 300;
                const centerY = 300;
                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.sqrt(dx*dx + dy*dy);
                const maxDistance = 270; // Adjusted to keep nodes inside the circle

                if (distance > maxDistance) {
                    const angle = Math.atan2(dy, dx);
                    node.style.left = `${centerX + maxDistance * Math.cos(angle) - 30}px`;
                    node.style.top = `${centerY + maxDistance * Math.sin(angle) - 30}px`;
                } else {
                    node.style.left = `${x}px`;
                    node.style.top = `${y}px`;
                }
                updateArrows();
            }

            function stopDragging() {
                document.removeEventListener('mousemove', moveNode);
                document.removeEventListener('mouseup', stopDragging);
            }

            document.addEventListener('mousemove', moveNode);
            document.addEventListener('mouseup', stopDragging);
        }

        function selectNode(e) {
            if (linkMode || unlinkMode) {
                const node = e.target;
                node.classList.toggle('node-highlight');
                if (selectedNodes.includes(node)) {
                    selectedNodes = selectedNodes.filter(n => n !== node);
                } else {
                    selectedNodes.push(node);
                }

                if (selectedNodes.length === 2) {
                    if (linkMode) {
                        linkNodes(selectedNodes[0], selectedNodes[1]);
                    } else if (unlinkMode) {
                        unlinkNodes(selectedNodes[0], selectedNodes[1]);
                    }
                    selectedNodes.forEach(n => n.classList.remove('node-highlight'));
                    selectedNodes = [];
                    linkMode = false;
                    unlinkMode = false;
                }
            }
        }

        function linkNodes(node1, node2) {
            const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            arrow.classList.add('arrow');
            arrow.style.overflow = 'visible';
            
            const arrowPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            arrowPath.setAttribute('fill', 'none');
            arrowPath.setAttribute('stroke', '#333');
            arrowPath.setAttribute('stroke-width', '2');
            
            arrow.appendChild(arrowPath);
            skillTree.insertBefore(arrow, skillTree.firstChild);
            links.push({ element: arrow, from: node1, to: node2 });
            
            updateArrowPosition(arrow, node1, node2);
        }

        function unlinkNodes(node1, node2) {
            const linkIndex = links.findIndex(link => 
                (link.from === node1 && link.to === node2) || 
                (link.from === node2 && link.to === node1)
            );
            if (linkIndex !== -1) {
                skillTree.removeChild(links[linkIndex].element);
                links.splice(linkIndex, 1);
            }
        }

        function updateArrowPosition(arrow, from, to) {
            const fromRect = from.getBoundingClientRect();
            const toRect = to.getBoundingClientRect();
            const treeRect = skillTree.getBoundingClientRect();
            
            const x1 = fromRect.left + fromRect.width / 2 - treeRect.left;
            const y1 = fromRect.top + fromRect.height / 2 - treeRect.top;
            const x2 = toRect.left + toRect.width / 2 - treeRect.left;
            const y2 = toRect.top + toRect.height / 2 - treeRect.top;
            
            arrow.setAttribute('width', skillTree.clientWidth);
            arrow.setAttribute('height', skillTree.clientHeight);
            
            const path = `M ${x1} ${y1} L ${x2} ${y2}`;
            arrow.querySelector('path').setAttribute('d', path);
        }

        function updateArrows() {
            links.forEach(link => {
                updateArrowPosition(link.element, link.from, link.to);
            });
        }

        function downloadJSON() {
            const data = {
                nodes: nodes.map(n => ({ id: n.id, shape: n.shape, x: n.x, y: n.y, name: n.name })),
                links: links.map(l => ({ source: l.source.id, target: l.target.id }))
            };
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "skill_tree.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        addCircleBtn.addEventListener('click', () => createNode('circle'));
        addSquareBtn.addEventListener('click', () => createNode('square'));
        linkNodesBtn.addEventListener('click', () => {
            linkMode = true;
            unlinkMode = false;
            alert('Select two nodes to link');
        });
        unlinkNodesBtn.addEventListener('click', () => {
            unlinkMode = true;
            linkMode = false;
            alert('Select two nodes to unlink');
        });

        // Initialize with some nodes to resemble the image
        for (let i = 0; i < 10; i++) {
            createNode(Math.random() > 0.5 ? 'circle' : 'square');
        }
    </script>
</body>
</html>
